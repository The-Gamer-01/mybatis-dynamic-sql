<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KotlinBaseBuilders.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MyBatis Dynamic SQL</a> &gt; <a href="index.source.html" class="el_package">org.mybatis.dynamic.sql.util.kotlin</a> &gt; <span class="el_source">KotlinBaseBuilders.kt</span></div><h1>KotlinBaseBuilders.kt</h1><pre class="source lang-java linenums">/*
 *    Copyright 2016-2022 the original author or authors.
 *
 *    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 *    you may not use this file except in compliance with the License.
 *    You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *    Unless required by applicable law or agreed to in writing, software
 *    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 *    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *    See the License for the specific language governing permissions and
 *    limitations under the License.
 */
package org.mybatis.dynamic.sql.util.kotlin

import org.mybatis.dynamic.sql.BindableColumn
import org.mybatis.dynamic.sql.AndOrCriteriaGroup
import org.mybatis.dynamic.sql.ExistsPredicate
import org.mybatis.dynamic.sql.SqlTable
import org.mybatis.dynamic.sql.VisitableCondition
import org.mybatis.dynamic.sql.select.AbstractQueryExpressionDSL
import org.mybatis.dynamic.sql.where.AbstractWhereDSL
import org.mybatis.dynamic.sql.where.AbstractWhereSupport

@Target(AnnotationTarget.CLASS, AnnotationTarget.TYPE)
@DslMarker
annotation class MyBatisDslMarker

typealias WhereApplier = KotlinBaseBuilder&lt;*&gt;.() -&gt; Unit

<span class="fc" id="L33">fun WhereApplier.andThen(after: WhereApplier): WhereApplier = {</span>
<span class="fc" id="L34">    invoke(this)</span>
<span class="fc" id="L35">    after(this)</span>
<span class="fc" id="L36">}</span>

<span class="fc" id="L38">@MyBatisDslMarker</span>
@Suppress(&quot;TooManyFunctions&quot;)
<span class="fc" id="L40">abstract class KotlinBaseBuilder&lt;D : AbstractWhereSupport&lt;*&gt;&gt; {</span>
    fun where(criteria: GroupingCriteriaReceiver): Unit =
<span class="fc" id="L42">        with(GroupingCriteriaCollector().apply(criteria)) {</span>
<span class="fc" id="L43">            this@KotlinBaseBuilder.getDsl().where(initialCriterion, subCriteria)</span>
<span class="fc" id="L44">        }</span>

    fun and(criteria: GroupingCriteriaReceiver): Unit =
<span class="fc" id="L47">        with(GroupingCriteriaCollector().apply(criteria)) {</span>
<span class="fc" id="L48">            this@KotlinBaseBuilder.getDsl().where().and(initialCriterion, subCriteria)</span>
<span class="fc" id="L49">        }</span>

    fun or(criteria: GroupingCriteriaReceiver): Unit =
<span class="fc" id="L52">        with(GroupingCriteriaCollector().apply(criteria)) {</span>
<span class="fc" id="L53">            this@KotlinBaseBuilder.getDsl().where().or(initialCriterion, subCriteria)</span>
<span class="fc" id="L54">        }</span>

<span class="fc" id="L56">    fun applyWhere(whereApplier: WhereApplier) = whereApplier.invoke(this)</span>

    @Deprecated(&quot;Deprecated in favor of the new where clause DSL. Update by moving the column and condition &quot; +
            &quot;into a lambda and rewriting the condition to use an infix function.&quot;)
    fun &lt;T&gt; where(column: BindableColumn&lt;T&gt;, condition: VisitableCondition&lt;T&gt;): Unit =
<span class="fc" id="L61">        applyToWhere {</span>
<span class="fc" id="L62">            where(column, condition)</span>
<span class="fc" id="L63">        }</span>

    @Deprecated(&quot;Deprecated in favor of the new where clause DSL. Update by moving the column and condition &quot; +
            &quot;inside the lambda and rewriting the condition to use an infix function.&quot;)
    fun &lt;T&gt; where(column: BindableColumn&lt;T&gt;, condition: VisitableCondition&lt;T&gt;, subCriteria: CriteriaReceiver): Unit =
<span class="fc" id="L68">        applyToWhere(subCriteria) { sc -&gt;</span>
<span class="fc" id="L69">            where(column, condition, sc)</span>
<span class="fc" id="L70">        }</span>

    @Deprecated(
        message = &quot;Deprecated in favor of the new where clause DSL.&quot;,
        replaceWith = ReplaceWith(&quot;where { existsPredicate }&quot;)
    )
    fun where(existsPredicate: ExistsPredicate): Unit =
<span class="fc" id="L77">        applyToWhere {</span>
<span class="fc" id="L78">            where(existsPredicate)</span>
<span class="fc" id="L79">        }</span>

    @Deprecated(&quot;Deprecated in favor of the new where clause DSL. Update by moving the exists expression &quot; +
            &quot;into the lambda.&quot;)
    fun where(existsPredicate: ExistsPredicate, subCriteria: CriteriaReceiver): Unit =
<span class="fc" id="L84">        applyToWhere(subCriteria) { sc -&gt;</span>
<span class="fc" id="L85">            where(existsPredicate, sc)</span>
<span class="fc" id="L86">        }</span>

    @Deprecated(&quot;Deprecated in favor of the new where clause DSL. Update by moving the column and condition &quot; +
            &quot;into a lambda and rewriting the condition to use an infix function.&quot;)
    fun &lt;T&gt; and(column: BindableColumn&lt;T&gt;, condition: VisitableCondition&lt;T&gt;): Unit =
<span class="fc" id="L91">        applyToWhere {</span>
<span class="fc" id="L92">            and(column, condition)</span>
<span class="fc" id="L93">        }</span>

    @Deprecated(&quot;Deprecated in favor of the new where clause DSL. Update by moving the column and condition &quot; +
            &quot;inside the lambda and rewriting the condition to use an infix function.&quot;)
    fun &lt;T&gt; and(column: BindableColumn&lt;T&gt;, condition: VisitableCondition&lt;T&gt;, subCriteria: CriteriaReceiver): Unit =
<span class="fc" id="L98">        applyToWhere(subCriteria) { sc -&gt;</span>
<span class="fc" id="L99">            and(column, condition, sc)</span>
<span class="fc" id="L100">        }</span>

    @Deprecated(
        message = &quot;Deprecated in favor of the new where clause DSL.&quot;,
        replaceWith = ReplaceWith(&quot;and { existsPredicate }&quot;)
    )
    fun and(existsPredicate: ExistsPredicate): Unit =
<span class="fc" id="L107">        applyToWhere {</span>
<span class="fc" id="L108">            and(existsPredicate)</span>
<span class="fc" id="L109">        }</span>

    @Deprecated(&quot;Deprecated in favor of the new where clause DSL. Update by moving the exists expression &quot; +
            &quot;into the lambda.&quot;)
    fun and(existsPredicate: ExistsPredicate, subCriteria: CriteriaReceiver): Unit =
<span class="fc" id="L114">        applyToWhere(subCriteria) { sc -&gt;</span>
<span class="fc" id="L115">            and(existsPredicate, sc)</span>
<span class="fc" id="L116">        }</span>

    @Deprecated(&quot;Deprecated in favor of the new where clause DSL. Update by moving the column and condition &quot; +
            &quot;into a lambda and rewriting the condition to use an infix function.&quot;)
    fun &lt;T&gt; or(column: BindableColumn&lt;T&gt;, condition: VisitableCondition&lt;T&gt;): Unit =
<span class="fc" id="L121">        applyToWhere {</span>
<span class="fc" id="L122">            or(column, condition)</span>
<span class="fc" id="L123">        }</span>

    @Deprecated(&quot;Deprecated in favor of the new where clause DSL. Update by moving the column and condition &quot; +
            &quot;inside the lambda and rewriting the condition to use an infix function.&quot;)
    fun &lt;T&gt; or(column: BindableColumn&lt;T&gt;, condition: VisitableCondition&lt;T&gt;, subCriteria: CriteriaReceiver): Unit =
<span class="fc" id="L128">        applyToWhere(subCriteria) { sc -&gt;</span>
<span class="fc" id="L129">            or(column, condition, sc)</span>
<span class="fc" id="L130">        }</span>

    @Deprecated(
        message = &quot;Deprecated in favor of the new where clause DSL.&quot;,
        replaceWith = ReplaceWith(&quot;or { existsPredicate }&quot;)
    )
    fun or(existsPredicate: ExistsPredicate): Unit =
<span class="fc" id="L137">        applyToWhere {</span>
<span class="fc" id="L138">            or(existsPredicate)</span>
<span class="fc" id="L139">        }</span>

    @Deprecated(&quot;Deprecated in favor of the new where clause DSL. Update by moving the exists expression &quot; +
            &quot;into the lambda.&quot;)
    fun or(existsPredicate: ExistsPredicate, subCriteria: CriteriaReceiver): Unit =
<span class="fc" id="L144">        applyToWhere(subCriteria) { sc -&gt;</span>
<span class="fc" id="L145">            or(existsPredicate, sc)</span>
<span class="fc" id="L146">        }</span>

    /**
     * This function does nothing, but it can be used to make some code snippets more understandable.
     *
     * For example, to count all rows in a table you can write either of the following:
     *
     * val rows = countFrom(foo) { }
     *
     *    or
     *
     * val rows = countFrom(foo) { allRows() }
     */
    @SuppressWarnings(&quot;EmptyFunctionBlock&quot;)
    fun allRows() {
        // intentionally empty - this function exists for code beautification and clarity only
<span class="fc" id="L162">    }</span>

    private fun applyToWhere(block: AbstractWhereDSL&lt;*&gt;.() -&gt; Unit) {
<span class="fc" id="L165">        getDsl().where().apply(block)</span>
<span class="fc" id="L166">    }</span>

    private fun applyToWhere(
        subCriteria: CriteriaReceiver,
        block: AbstractWhereDSL&lt;*&gt;.(List&lt;AndOrCriteriaGroup&gt;) -&gt; Unit
    ) {
<span class="fc" id="L172">        getDsl().where().block(CriteriaCollector().apply(subCriteria).criteria)</span>
<span class="fc" id="L173">    }</span>

    protected abstract fun getDsl(): D
}

@Suppress(&quot;TooManyFunctions&quot;)
<span class="fc" id="L179">abstract class KotlinBaseJoiningBuilder&lt;D : AbstractQueryExpressionDSL&lt;*, *&gt;&gt; : KotlinBaseBuilder&lt;D&gt;() {</span>

    fun join(table: SqlTable, joinCriteria: JoinReceiver): Unit =
<span class="fc" id="L182">        applyToDsl(joinCriteria) { jc -&gt;</span>
<span class="fc" id="L183">            join(table, jc.onJoinCriterion(), jc.andJoinCriteria)</span>
<span class="fc" id="L184">        }</span>

    fun join(table: SqlTable, alias: String, joinCriteria: JoinReceiver): Unit =
<span class="fc" id="L187">        applyToDsl(joinCriteria) { jc -&gt;</span>
<span class="fc" id="L188">            join(table, alias, jc.onJoinCriterion(), jc.andJoinCriteria)</span>
<span class="fc" id="L189">        }</span>

    fun join(
        subQuery: KotlinQualifiedSubQueryBuilder.() -&gt; Unit,
        joinCriteria: JoinReceiver
    ): Unit =
<span class="fc" id="L195">        applyToDsl(subQuery, joinCriteria) { sq, jc -&gt;</span>
<span class="fc" id="L196">            join(sq, sq.correlationName, jc.onJoinCriterion(), jc.andJoinCriteria)</span>
<span class="fc" id="L197">        }</span>

    fun fullJoin(table: SqlTable, joinCriteria: JoinReceiver): Unit =
<span class="fc" id="L200">        applyToDsl(joinCriteria) { jc -&gt;</span>
<span class="fc" id="L201">            fullJoin(table, jc.onJoinCriterion(), jc.andJoinCriteria)</span>
<span class="fc" id="L202">        }</span>

    fun fullJoin(table: SqlTable, alias: String, joinCriteria: JoinReceiver): Unit =
<span class="fc" id="L205">        applyToDsl(joinCriteria) { jc -&gt;</span>
<span class="fc" id="L206">            fullJoin(table, alias, jc.onJoinCriterion(), jc.andJoinCriteria)</span>
<span class="fc" id="L207">        }</span>

    fun fullJoin(
        subQuery: KotlinQualifiedSubQueryBuilder.() -&gt; Unit,
        joinCriteria: JoinReceiver
    ): Unit =
<span class="fc" id="L213">        applyToDsl(subQuery, joinCriteria) { sq, jc -&gt;</span>
<span class="fc" id="L214">            fullJoin(sq, sq.correlationName, jc.onJoinCriterion(), jc.andJoinCriteria)</span>
<span class="fc" id="L215">        }</span>

    fun leftJoin(table: SqlTable, joinCriteria: JoinReceiver): Unit =
<span class="fc" id="L218">        applyToDsl(joinCriteria) { jc -&gt;</span>
<span class="fc" id="L219">            leftJoin(table, jc.onJoinCriterion(), jc.andJoinCriteria)</span>
<span class="fc" id="L220">        }</span>

    fun leftJoin(table: SqlTable, alias: String, joinCriteria: JoinReceiver): Unit =
<span class="fc" id="L223">        applyToDsl(joinCriteria) { jc -&gt;</span>
<span class="fc" id="L224">            leftJoin(table, alias, jc.onJoinCriterion(), jc.andJoinCriteria)</span>
<span class="fc" id="L225">        }</span>

    fun leftJoin(
        subQuery: KotlinQualifiedSubQueryBuilder.() -&gt; Unit,
        joinCriteria: JoinReceiver
    ): Unit =
<span class="fc" id="L231">        applyToDsl(subQuery, joinCriteria) { sq, jc -&gt;</span>
<span class="fc" id="L232">            leftJoin(sq, sq.correlationName, jc.onJoinCriterion(), jc.andJoinCriteria)</span>
<span class="fc" id="L233">        }</span>

    fun rightJoin(table: SqlTable, joinCriteria: JoinReceiver): Unit =
<span class="fc" id="L236">        applyToDsl(joinCriteria) { jc -&gt;</span>
<span class="fc" id="L237">            rightJoin(table, jc.onJoinCriterion(), jc.andJoinCriteria)</span>
<span class="fc" id="L238">        }</span>

    fun rightJoin(table: SqlTable, alias: String, joinCriteria: JoinReceiver): Unit =
<span class="fc" id="L241">        applyToDsl(joinCriteria) { jc -&gt;</span>
<span class="fc" id="L242">            rightJoin(table, alias, jc.onJoinCriterion(), jc.andJoinCriteria)</span>
<span class="fc" id="L243">        }</span>

    fun rightJoin(
        subQuery: KotlinQualifiedSubQueryBuilder.() -&gt; Unit,
        joinCriteria: JoinReceiver
    ): Unit =
<span class="fc" id="L249">        applyToDsl(subQuery, joinCriteria) { sq, jc -&gt;</span>
<span class="fc" id="L250">            rightJoin(sq, sq.correlationName, jc.onJoinCriterion(), jc.andJoinCriteria)</span>
<span class="fc" id="L251">        }</span>

    private fun applyToDsl(joinCriteria: JoinReceiver, applyJoin: D.(JoinCollector) -&gt; Unit) {
<span class="fc" id="L254">        getDsl().applyJoin(JoinCollector().apply(joinCriteria))</span>
<span class="fc" id="L255">    }</span>

    private fun applyToDsl(
        subQuery: KotlinQualifiedSubQueryBuilder.() -&gt; Unit,
        joinCriteria: JoinReceiver,
        applyJoin: D.(KotlinQualifiedSubQueryBuilder, JoinCollector) -&gt; Unit
    ) {
<span class="fc" id="L262">        getDsl().applyJoin(KotlinQualifiedSubQueryBuilder().apply(subQuery), JoinCollector().apply(joinCriteria))</span>
<span class="fc" id="L263">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>